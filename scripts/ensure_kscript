#!/usr/bin/env bash

. announce-menu --import

echo -en "Checking dependencies...\r"

function _in_path() {
	command -v "$1" >/dev/null 2>&1
}

_sdkman_path="$HOME/.sdkman/bin/sdkman-init.sh"
[[ -f $_sdkman_path ]] && . "$_sdkman_path"

function _install_sdkman_kscript() {
	if declare -f sdk >/dev/null; then
		echo -en "[->     ] SDKMAN is installed...      \r"
	else
		echo -en "[>      ] Checking dependencies...    \r"

		if ! _in_path curl; then
			echo "'curl' is not installed...            "
			packager install curl || exit 1
		fi

		if ! _in_path zip; then
			echo "'zip' is not installed..."
			packager install zip || exit 1
		fi

		if ! _in_path unzip; then
			echo "'unzip' is not installed..."
			packager install unzip || exit 1
		fi

		echo "[->     ] Installing SDKMAN..."
		curl -L "https://get.sdkman.io" | bash >/dev/null 2>/dev/null
		source "$_sdkman_path"
	fi

	if ! _in_path java; then
		echo -en "[-->   ] Installing java...          \r"
		sdk install java >/dev/null 2>/dev/null
	fi

	if ! _in_path kotlin; then
		echo -en "[--->  ] Installing kotlin...          \r"
		sdk install kotlin >/dev/null 2>/dev/null
	fi

	if ! _in_path gradle; then
		echo -en "[----> ] Installing gradle...          \r"
		sdk install gradle >/dev/null 2>/dev/null
	fi

	if ! _in_path kscript; then
		echo -en "[----->] Installing kscript...          \r"
		sdk install kscript >/dev/null 2>/dev/null
	fi

	source "$_sdkman_path"
}

if ! _in_path kscript; then
	echo "This script needs 'kscript', which is missing from your system."

	echo "Type '0' to install SDKMAN and kscript automatically."
	echo "Type '1' to install kscript using packager."
	echo "Type anything else to quit."
	read -t 10 -r _user_choice || _user_choice="0"
	case "$_user_choice" in
	0)
		_install_sdkman_kscript
		;;
	1)
		packager install kscript
		;;
	*)
		exit 0
		;;
	esac
fi

echo -en "Working...                                                          \r"
exec kscript "$@"

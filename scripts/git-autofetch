#!/bin/bash

fetch_head=$(git data --git-dir)/FETCH_HEAD
[[ ! -f "$fetch_head" ]] && should_fetch=true

if [[ $should_fetch != true ]]; then
	last_fetch=$(stat -c %Y "$fetch_head")
	now=$(date +%s)
	diff=$((now - last_fetch))

	[[ $diff -gt 600 ]] && should_fetch=true
fi

[[ $should_fetch != true ]] && exit 0

announce "Automatically fetching the repository $(git data --root)..."
git fetch --all --prune || exit 1
[[ $(git data --tracked) == "" ]] && exit 0
COMMITS=$(git log .."$(git data --tracked)")
if [[ "$COMMITS" != "" ]]; then
	echo
	git changelog .."$(git data --tracked)"
fi

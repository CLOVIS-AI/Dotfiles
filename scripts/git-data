#!/bin/bash

case $1 in
--check-repo)
	[[ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" == 'true' ]] || \
	[[ "$(git rev-parse --is-bare-repository 2>/dev/null)" == 'true' ]]
	;;
--tracked)
	# From https://stackoverflow.com/a/9753364/5666171
	git for-each-ref --format='%(upstream:short)' "$(git symbolic-ref -q HEAD)";;
--root)
	git rev-parse --show-toplevel;;
--git-dir)
	git rev-parse --git-dir;;
--is-merging)
	git rev-parse -q --verify MERGE_HEAD >/dev/null;;
--is-rebasing)
	# shellcheck disable=SC2010
	ls "$(git data --git-dir)" | grep rebase >/dev/null;;
--current)
	git rev-parse --abbrev-ref HEAD;;
--ahead-after|--status)
	git data --check-repo || exit 0
	current="$(git data --current 2>/dev/null)"
	[[ $? == 128 ]] && echo "no branch" && exit 0
	tracked="$(git data --tracked)"

	RET="${current}"
	git data --is-merging && RET+=" merge"
	git data --is-rebasing && RET+=" rebase"
	RET+=" $(git rev-list "$tracked..$current" | wc -l)↑"
	RET+=" $(git rev-list "$current..$tracked" | wc -l)↓"
	# shellcheck disable=SC2001
	<<<"$RET" \
		sed 's/ 0↑ 0↓/ ⮁/;s/ 0[↑↓]//g;s/ merge/ ⤮ currently merging/;s/ rebase/ ⟳ currently rebasing/;
		s/HEAD/detached HEAD/';;
esac
